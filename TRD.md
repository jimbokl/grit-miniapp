## TRD: Grit Telegram Bot — MVP спецификация

### 1. Цели и контекст
- **Цель продукта**: помочь индивидуальному пользователю выстроить ежедневный рабочий ритм через простую фиксацию ключевых метрик, мягкие напоминания и еженедельную обратную связь.
- **MVP-гипотеза**: регулярные утренние/вечерние касания и быстрые дневные отметки повышают вероятность достижения финансовых целей за счёт дисциплины и фокуса.
- **Релиз**: MVP за 7 дней, запуск бота в Telegram, одиночный пользовательский сценарий.

### 2. Область и ограничения
- **В scope**:
  - Утренний сбор планов по 3 метрикам, быстрые команды учёта в течение дня, вечерний отчёт, недельное резюме.
  - Персональные цели, таймзона, расписание напоминаний на пользователя.
  - Хранение и агрегирование данных, простые рекомендации «узкое место недели».
- **Вне scope (MVP)**:
  - Командные/групповые чаты, веб-дашборд, интеграции CRM, ML-рекомендации, мульти-языковая локализация (кроме RU), сложные ролевая модель/админка, импорт/экспорт данных.
- **Ограничения**:
  - Только PostgreSQL как основное хранилище (без Redis/TimescaleDB, без Google Sheets/SQLite в проде).
  - Хостинг: бюджетный PaaS (Railway/Render/Heroku). Достаточно best-effort uptime.

### 3. Пользовательская ценность и сценарии
- **Персона**: индивидуальный предприниматель/сейлз/фаундер с KPI по выручке.
- **Ключевые сценарии**:
  1) Утро (08:30) — бот спрашивает планы по 3 метрикам на день.
  2) Днём — пользователь отправляет быстрые команды учёта: `/касания 12`, `/демо 1`, `/фокус 90`.
  3) Вечер (20:30) — бот собирает факт, оценивает «идеальный день», спрашивает урок.
  4) Воскресенье — недельный дайджест с трендами и одной рекомендацией.
  5) Антибаг — если пропущен отчёт, мягкий нудж и предложение «минимума», чтобы не ломать цепочку.

### 4. Функциональные требования
- **Команды Telegram**:
  - `/start` — онбординг: таймзона, цели (касания/демо/фокус), время утреннего/вечернего напоминаний.
  - `/goals` — просмотр/изменение дневных целей.
  - `/касания N` — увеличить дневной счётчик «касания» на N.
  - `/демо N` — увеличить дневной счётчик «демо/диагностики» на N.
  - `/фокус M` — добавить M минут фокусной работы.
  - `/отчёт` — показать текущие суммы за день и прогресс к целям.
  - `/стата` — показать простую статистику за неделю (Σ по метрикам, идеальные дни, пилоты).
  - `/минимум` — отметить минимальную версию дня (не ломать цепочку).
  - `/help` — краткая справка и примеры команд.
- **Диалоги и тексты**:
  - Тон: позитивно-нейтральный, без морализаторства; короткие, конкретные ответы.
  - Примеры:
    - "Принял 12 касаний. Осталось 8 до цели."
    - "Сегодня 2 из 3. Это +1 к серии. Что улучшишь завтра одной фразой?"
    - "3/5 идеальных дней. Узкое место — демо. План: 2 новых канала лидов на следующей неделе."
- **Напоминания**:
  - Утро: запрос планов по трём метрикам.
  - Вечер: сверка «обещано/сделано», расчёт «идеального дня».
  - Неделя (вс): чекап по целям, тренды, узкое место, 1 рекомендация.
- **Бизнес-правила**:
  - Дневные цели: `касания`, `демо`, `фокус (мин)`.
  - "Идеальный день": все три дневные цели выполнены или превышены.
  - "Минимум": пользователь вручную помечает день, чтобы не прерывать серию; минимальный порог задаётся на онбординге или по умолчанию `касания>=1 OR фокус>=15 мин`.
  - Конверсия в пилоты: опционально как недельная метрика (ручной ввод через `/стата` в MVP не обязателен).
- **Временные правила**:
  - Таймзона хранится на пользователя; планировщик учитывает смещение.
  - Неделя: пн–вс. Сдвиг недели — по таймзоне пользователя.

### 5. Нефункциональные требования
- **Надёжность**: сохранение всех пользовательских событий в БД, идемпотентность обработчика апдейтов.
- **Производительность**: целевая задержка ответа < 1–2 с при типовой нагрузке одиночных пользователей.
- **Безопасность**: секреты в переменных окружения; ограничение источников вебхука; валидация входных данных.
- **Наблюдаемость**: структурированные логи (уровни info/warn/error), счётчики ошибок и отправленных сообщений.
- **Конфиденциальность**: персональные данные минимальны; опция удаления аккаунта и данных (позже).

### 6. Архитектура и стек
- **Язык/фреймворк**: Python 3.11+, `python-telegram-bot`.
- **Хранилище**: PostgreSQL 14+ (единственная БД в MVP).
- **Планировщик**: `APScheduler` внутри приложения или хостинговый cron.
- **Деплой**: Railway/Render/Heroku (один веб-процесс + фоновые задачи в том же приложении).
- **Обработка апдейтов**: webhook (предпочтительно) или polling (резерв).

### 7. Модели данных и схема БД (PostgreSQL)
- `users`
  - `user_id BIGINT PRIMARY KEY` — Telegram ID
  - `timezone TEXT NOT NULL` — IANA, напр. `Europe/Moscow`
  - `goal_touches INT NOT NULL` — дневная цель «касания»
  - `goal_demos INT NOT NULL` — дневная цель «демо»
  - `goal_focus_minutes INT NOT NULL` — дневная цель «фокус (мин)`
  - `morning_at TIME NOT NULL` — локальное время утреннего пинга
  - `evening_at TIME NOT NULL` — локальное время вечернего пинга
  - `minimum_enabled BOOLEAN NOT NULL DEFAULT true`
  - `minimum_focus_minutes INT NOT NULL DEFAULT 15`
  - `created_at TIMESTAMPTZ NOT NULL DEFAULT now()`
  - `updated_at TIMESTAMPTZ NOT NULL DEFAULT now()`
- `daily_logs`
  - `id BIGSERIAL PRIMARY KEY`
  - `user_id BIGINT NOT NULL REFERENCES users(user_id)`
  - `date DATE NOT NULL` — локальная дата пользователя
  - `touches INT NOT NULL DEFAULT 0`
  - `demos INT NOT NULL DEFAULT 0`
  - `focus_minutes INT NOT NULL DEFAULT 0`
  - `promised_touches INT` — план на утро (опционально)
  - `promised_demos INT`
  - `promised_focus_minutes INT`
  - `is_minimum BOOLEAN NOT NULL DEFAULT false`
  - `is_ideal BOOLEAN NOT NULL DEFAULT false`
  - `lesson TEXT` — короткий урок дня
  - `created_at TIMESTAMPTZ NOT NULL DEFAULT now()`
  - `updated_at TIMESTAMPTZ NOT NULL DEFAULT now()`
  - Уникальный индекс: `(user_id, date)`
- `weekly_snapshots` (опционально, можно считать on-the-fly)
  - `user_id BIGINT NOT NULL`
  - `week_start DATE NOT NULL` — понедельник
  - агрегаты Σ и производные метрики (идеальные дни, узкое место)
  - Уникальный индекс: `(user_id, week_start)`
- Индексы: по `users.user_id`, `daily_logs.user_id,date`.

### 8. Правила расчётов и логика
- **Обновление дневных значений**: инкременты по командам; отсутствие отрицательных значений; валидация аргументов.
- **Определение «идеального дня»**: при вечернем отчёте, если `touches>=goal_touches AND demos>=goal_demos AND focus_minutes>=goal_focus_minutes` → `is_ideal=true`.
- **"Минимум"**: если пользователь вызывает `/минимум`, день помечается `is_minimum=true`; серия «идеальных/минимальных» дней не прерывается.
- **Неделя**: агрегаты по пн–вс; «узкое место» — метрика с наименьшим % выполнения цели среди трёх.
- **Рекомендация**: текст-шаблон на основе «узкого места» (например, если демо — предложить 1–2 новых канала лидогенерации).

### 9. Интеграция с Telegram
- **Webhook**: `POST /webhook`, секрет в пути/заголовке, проверка IP (по возможности хостинга) + токен.
- **Командный парсер**: строгая валидация числовых аргументов, локализованные ответы об ошибках.
- **Антидубль**: идемпотентность по `update_id`.

### 10. Конфигурация и окружение
- Обязательные переменные:
  - `TELEGRAM_BOT_TOKEN`
  - `DATABASE_URL` (Postgres)
  - `WEBHOOK_BASE_URL` (для webhook-режима)
  - `DEFAULT_TIMEZONE` (fallback)
- Параметры запуска: порт HTTP, флаги режима (webhook/polling).

### 11. Тестирование и качество
- Юнит-тесты: парсинг команд, валидация входа, правила «идеального дня» и «минимума».
- Интеграционные: запись/чтение из БД, обработка webhook.
- Нагрузочные (легкие): серийные инкременты метрик.

### 12. План релиза (7 дней) и DoD
- День 1: утверждение ТЗ, регистрация бота, настройка репо/CI/CD, скелет сервиса.
- День 2–3: команды `/start`, `/goals`, запись в Postgres, утреннее/вечернее напоминание.
- День 4: быстрые команды обновления, `/отчёт`, простая `/стата`.
- День 5: недельный сводный отчёт + простая рекомендация.
- День 6: логика «не ломать цепочку», `/минимум`.
- День 7: тест 2–3 дня, полировка текстов, деплой.
- **DoD**: все команды работают, напоминания по таймзоне, данные сохраняются, недельный отчёт формируется, без критических ошибок/падений.

### 13. Риски и компромиссы
- Ошибки таймзон → строгие тесты конверсии локального времени в UTC.
- Надёжность cron/APScheduler на бесплатном PaaS → резервный поллинг/ручной `/отчёт`.
- Отсутствие Redis/очередей → простая архитектура, но ограниченная масштабируемость (приемлемо для MVP).

### 14. Расширения после MVP
- Веб-дашборд, доп. метрики, интеграции (CRM/календарь), многоязычность, smart-рекомендации, персональные KPI-линейки и автопланирование.


