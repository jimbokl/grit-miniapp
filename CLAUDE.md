## CLAUDE: Принципы разработки Grit Telegram Bot

Этот документ фиксирует обязательные стандарты разработки проекта Grit (Telegram-бот). Следуй им при любых доработках.

### 1) Базовые принципы
- **Стек**: строго Python 3.11+; фреймворк Telegram — `python-telegram-bot`.
- **Хранилище**: только PostgreSQL (без Redis/TimescaleDB/SQLite/Sheets в проде). Резервные in-memory механики запрещены для боевых фич. [[TRD]] и внутреннее правило только Postgres [[memory:6357721]].
- **LLM-генерация**: использовать Gemini для генерации кода/текстов (промпт-инжиниринг, шаблоны, рефакторинг). Все сгенерированные изменения — через ревью и автотесты.
- **Зависимости**: доступ к новым библиотекам через MCP `context7` (блок «Процесс через MCP context7» ниже). Пиннинг версий обязателен.
- **Инфра**: Railway/Render/Heroku. Вебхук Telegram — предпочтительно; polling — резерв.

### 2) Архитектура
- Модули (ориентир): `main.py` (вход, DI), `handlers/` (команды и диалоги), `storage/` (репозитории), `scheduler/` (напоминания APScheduler), `services/` (доменные правила), `config/` (env), `db/` (миграции Alembic, схемы).
- Никаких побочных эффектов при импорте модулей. Настройка — только через явные фабрики и `config`.
- Компоненты отделять интерфейсами (протоколы/абстракции) для тестируемости.

### 3) Доменные правила (см. TRD)
- Дневные цели: `касания`, `демо`, `фокус (мин)`.
- «Идеальный день»: выполнение всех трёх целей; «минимум» — ручная отметка, не прерывающая серию.
- Таймзона per-user, неделя пн–вс, вечерняя сверка обещано/сделано.

### 4) Качество кода
- PEP 8, типы везде (Python typing), явные сигнатуры публичных API.
- Стиль: `black` + `flake8` + `isort`; статанализ: `mypy` (строгий режим где возможно).
- Именование: говорящие имена, без аббревиатур, ранние возвраты, без глубокой вложенности.
- Исключения: не глушить; логировать и поднимать на уровень обработчика, где есть стратегия.
- Конфигурация только через переменные окружения и `config`; никаких секретов в коде.

### 5) База данных
- Схема — согласно TRD (`users`, `daily_logs`, `weekly_snapshots`).
- Миграции через Alembic; без «ручных» правок схемы на проде.
- Инварианты: уникальные ключи, внешние ключи, индексы на частые запросы; транзакции вокруг мутирующих операций.
- N+1 избегать: использовать агрегирующие запросы/вьюхи там, где уместно.

### 6) Планировщик и время
- Напоминания через APScheduler; расписания — в локальном времени пользователя, хранение — UTC.
- Правила конверта таймзон — покрыть тестами. Надёжность cron на PaaS — держать резервный путь (ручные команды/поллинг).

### 7) Логирование и наблюдаемость
- Структурные логи JSON: уровень, timestamp, `user_id`, `update_id`, тип события.
- Метрики: счётчик успешных/ошибочных апдейтов, отправленных сообщений, длительность обработок.
- Корреляция: `trace_id` на обработку апдейта.

### 8) Безопасность
- Секреты только в ENV; ротация токенов.
- Webhook: секрет в пути/заголовке, проверка источников, валидация payload.
- Входные данные — строгая валидация, санитизация, ограничение числовых диапазонов.

### 9) Тестирование
- Юнит: парсер команд, валидация, бизнес-правила «идеальный день/минимум».
- Интеграционные: БД (через тестовый контейнер Postgres), webhook/handler цепочки.
- Покрытие: целевые 80%+, критичные ветви — 100%.
- Тесты детерминированы: фиксация времени/таймзон через фикстуры.

### 10) Деплой
- CI: линтеры, типизация, тесты, миграции Alembic в pre-deploy шаге (dry-run), затем apply.
- Хостинг: 1 web-процесс, внутр. планировщик. Health-check endpoint.
- Rollback: хранить последние миграции и артефакты, быстро откатываться.

### 11) Процесс генерации с Gemini
- Промпты и требования фиксировать в PR-описании.
- Никогда не мёрджить «как есть» без ревью и тестов.
- Любая генерация кода — с пояснением решений, ссылкой на TRD/CLAUDE.
- Не запускать сгенерированный код без песочницы/локального окружения.

### 12) Процесс через MCP `context7`
- 1) Запросить/поиск библиотеки через `context7` (совместимость Python 3.11+, лицензия permissive).
- 2) Проверить популярность/поддержку (звёзды, свежие релизы, issues). Оценить размер зависимостей.
- 3) Добавить в `pyproject.toml`/`requirements.txt` с фиксированной версией.
- 4) Локально прогнать типизацию/линтеры/тесты. Проверить безопасность (возможные CVE).
- 5) Обновить TRD/CLAUDE при существенных архитектурных влияниях.

### 13) Правила команды
- Не ломать рабочий код при исправлении ошибок: правим только саму ошибку.
- Никогда не создавать тестовые скрипты и не подмешивать тестовые данные в рабочую базу/код.
- Русская локаль ответов по умолчанию; тон позитивно-нейтральный.

### 14) Definition of Done (DoD)
- Фича описана в TRD, есть автотесты, проходят линтеры/типизация, миграции применяются, логирование/метрики на месте, деплой успешен, регрессий нет.

### 15) Ссылки
- TRD: `TRD.md`


